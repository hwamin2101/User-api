<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Socket.IO Test</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    button { padding: 12px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
    button.leave { background: #ff4444; color: white; }
    button.reset { background: #333; color: white; }
    #log { background: #f0f0f0; padding: 15px; height: 500px; overflow-y: auto; font-family: monospace; border: 1px solid #ddd; border-radius: 5px; }
    .msg { margin: 10px 0; padding: 10px; background: #e9e9e9; border-radius: 5px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Socket.IO Real-time Test</h1>
    <div id="status" class="status info">Nhập token từ Postman để bắt đầu</div>
    <p><strong>User:</strong> <span id="user">Chưa kết nối</span></p>

    <button onclick="resetTest()" class="reset">Reset & Nhập Token Mới</button>
    <button onclick="joinRoom()">Join Room</button>
    <button onclick="leaveRoom()" class="leave">Leave Room</button>
    <button onclick="sendMessage()">Send Message</button>
    <button onclick="sendNotify()">Send Notify</button>
    <button onclick="typing(true)">Typing ON</button>
    <button onclick="typing(false)">Typing OFF</button>

    <div id="log"></div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const log = document.getElementById('log');
    const userEl = document.getElementById('user');

    function setStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    function add(event, data) {
      const div = document.createElement('div');
      div.className = 'msg';
      div.innerHTML = `<strong>${new Date().toLocaleTimeString()} - ${event}</strong><pre>${JSON.stringify(data, null, 2)}</pre>`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function resetTest() {
      localStorage.removeItem('token');
      setStatus('Đã xóa token cũ. Nhập token mới từ Postman.', 'success');
      setTimeout(() => {
        const newToken = prompt('Dán token từ Postman vào đây:');
        if (newToken && newToken.trim()) {
          localStorage.setItem('token', newToken.trim());
          setStatus('Token đã lưu! Đang kết nối...', 'info');
          location.reload();
        } else {
          setStatus('Token không hợp lệ!', 'error');
        }
      }, 500);
    }

    const token = localStorage.getItem('token');
    if (!token) {
      setStatus('Chưa có token. Click "Reset & Nhập Token Mới" để dán token từ Postman.', 'error');
    } else {
      setStatus('Đang kết nối với token đã lưu...', 'info');
      initSocket(token);
    }

    function initSocket(token) {
      const socket = io({
        auth: { token },
        transports: ['websocket']
      });

      socket.on('connect', () => {
        add('Connected', { id: socket.id });
        setStatus('Kết nối thành công!', 'success');

        fetch('/api/users/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(r => r.json())
        .then(u => {
          userEl.textContent = u.email || u.name || 'Unknown';
        })
        .catch(() => {
          userEl.textContent = 'Lấy user thất bại';
        });
      });

      socket.on('disconnect', () => {
        add('Disconnected', null);
        setStatus('Mất kết nối', 'error');
      });

      socket.on('connect_error', (err) => {
        add('Connect Error', { message: err.message });
        setStatus(`Lỗi: ${err.message} (Token sai hoặc hết hạn?)`, 'error');
      });

      socket.on('room:joined', d => add('room:joined', d));
      socket.on('room:members', d => add('room:members', d));
      socket.on('room:message', d => add('room:message', d));
      socket.on('room:user-joined', d => add('room:user-joined', d));
      socket.on('room:user-left', d => add('room:user-left', d));
      socket.on('notification:receive', d => add('notification:receive', d));
      socket.on('state:typing', d => add('state:typing', d));

      window.joinRoom = () => socket.emit('room:join', { roomId: 'chat-123' });
      window.leaveRoom = () => socket.emit('room:leave', { roomId: 'chat-123' });
      window.sendMessage = () => {
        const msg = prompt('Tin nhắn:', 'Hello from test page!');
        if (msg) socket.emit('room:message', { roomId: 'chat-123', message: msg });
      };
      window.sendNotify = () => socket.emit('notification:send', { targetUserId: 2, title: 'Hi', body: 'From test page!' });
      window.typing = (isTyping) => socket.emit('state:typing', { roomId: 'chat-123', isTyping });
    }
  </script>
</body>
</html>